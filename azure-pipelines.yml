trigger:
- main  # Se ejecuta cuando hay cambios en la rama principal

pool:
  name: "Agent"  # Nombre del agente autohospedado

variables:
- group: varcody  # Grupo de variables con credenciales de JFrog

steps:

- script: |
    echo "游냀 Instalando Python y herramientas necesarias..."
    sudo apt-get update && sudo apt-get install -y python3 python3-venv python3-pip

    echo "游늭 Creando entorno virtual..."
    python3 -m venv venv

    echo "游댃 Activando entorno virtual..."
    source venv/bin/activate

    echo "游닌 Instalando dependencias desde Artifactory..."
    pip install --upgrade pip
    pip install --extra-index-url $(JFROG_PYPI_URL) -r requirements.txt
  displayName: "Instalar dependencias desde Artifactory"
  
# 游댳 Configurar Python e instalar dependencias desde Artifactory
- script: |
    echo "游냀 Configurando Python..."
    python3 -m venv venv
    source venv/bin/activate
    echo "游닌 Instalando dependencias desde Artifactory..."
    pip install --extra-index-url $(ARTIFACTORY_URL) -r requirements.txt
  displayName: "Instalar dependencias desde Artifactory"

# 游댏 Login en JFrog Artifactory para Docker
- task: Docker@2
  displayName: 'Login en JFrog Artifactory'
  inputs:
    containerRegistry: $(ARTIFACTORY_CR)
    command: 'login'

# 游댣 Construcci칩n de la imagen Docker
- script: |
    echo "游 Construyendo imagen Docker..."
    docker build -t $(JFROG_URL)/$(DOCKER_REPOSITORY)/$(IMAGE_NAME):$(IMAGE_TAG) .
  displayName: "Construcci칩n de la imagen Docker"

# 游닋 Subir la imagen a Artifactory
- script: |
    echo "游닋 Subiendo imagen a Artifactory..."
    docker push $(JFROG_URL)/$(DOCKER_REPOSITORY)/$(IMAGE_NAME):$(IMAGE_TAG)
  displayName: "Subir imagen a Artifactory"

# 游빛 Opcional: Limpiar im치genes locales para liberar espacio
- script: |
    echo "游빛 Limpiando im치genes locales..."
    docker image prune -f
  displayName: "Limpieza de im치genes locales"
  condition: succeeded()
